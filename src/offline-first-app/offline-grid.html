
<script src="../../bower_components/pouchdb/dist/pouchdb.min.js"></script>
<script src="../../bower_components/pouchdb-quick-search/dist/pouchdb.quick-search.min.js"></script>

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/polymer/lib/elements/dom-if.html">

<link rel="import" href="../../bower_components/vaadin-valo-theme/vaadin-grid.html">
<link rel="import" href="../../bower_components/vaadin-valo-theme/vaadin-button.html">
<link rel="import" href="../../bower_components/vaadin-icons/vaadin-icons.html">

<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../bower_components/vaadin-button/vaadin-button.html">

<dom-module id="offline-grid">
  <template>
    <style>
      :host {
        display: block;
      }

      #lazyGrid {
        height: 100%;
        width: 100%;
      }

      .grid-cell {
        display: inline;
      }

      .search-highlight {
          background-color: yellow;
      }

      .add-button {
        position: absolute;
        right: 20px;
        bottom: 20px;
        border-radius: 50%;
        font-size: 12px;
      }
    </style>

    <vaadin-grid id="lazyGrid"
                 aria-label="Offline Grid"
                 data-provider="[[dataProvider]]"
                 active-item="{{activeItem}}"
                 selected-items="{{selectedItems}}"
                 item-id-path="_id"
                 size="[[size]]">

      <vaadin-grid-column width="250px" flex-grow="0">
        <template class="header">Name</template>
        <template>
          <span class="grid-cell">
            <template is="dom-if" if="[[item.highlight_firstName]]">
              <span inner-H-T-M-L="[[item.highlight_firstName]]"></span>
            </template>
            <template is="dom-if" if="[[!item.highlight_firstName]]">
              [[item.firstName]]
            </template>
            <template is="dom-if" if="[[item.highlight_lastName]]">
                <span inner-H-T-M-L="[[item.highlight_lastName]]"></span>
            </template>
            <template is="dom-if" if="[[!item.highlight_lastName]]">
              [[item.lastName]]
            </template>
          </span>
        </template>
      </vaadin-grid-column>

      <vaadin-grid-column width="170px" flex-grow="0">
        <template class="header">Phone</template>
        <template>
          <span class="grid-cell">
            <template is="dom-if" if="[[item.highlight_address_phone]]">
              <span inner-H-T-M-L="[[item.highlight_address_phone]]"></span>
            </template>
            <template is="dom-if" if="[[!item.highlight_address_phone]]">
              [[item.address.phone]]
            </template>
          </span>
        </template>
      </vaadin-grid-column>

      <vaadin-grid-column flex-grow="1">
        <template class="header">Address</template>
        <template>
          <span class="grid-cell">
            <template is="dom-if" if="[[item.highlight_address_street]]">
              <span inner-H-T-M-L="[[item.highlight_address_street]]"></span>
            </template>
            <template is="dom-if" if="[[!item.highlight_address_street]]">
              [[item.address.street]]
            </template>
            <template is="dom-if" if="[[item.address.city]]">
              ,
            </template>
            <template is="dom-if" if="[[item.highlight_address_city]]">
              <span inner-H-T-M-L="[[item.highlight_address_city]]"></span>
            </template>
            <template is="dom-if" if="[[!item.highlight_address_city]]">
              [[item.address.city]]
            </template>
          </span>
        </template>
      </vaadin-grid-column>

    </vaadin-grid>

    <div style="position:relative">
      <vaadin-button class="add-button" on-tap="add" theme="icon primary">
          <iron-icon icon="vaadin:plus"></iron-icon>
      </vaadin-button>
    </div>
  </template>

  <script>
    Polymer({

      is: 'offline-grid',

      properties: {
        activeItem: {
          observer: '_activeItemChanged',
        },

        selectedItems: {
          observer: '_selectedItemsChanged',
        },

        // Remote DB, running on a local instance of CouchDB.
        remoteDB: {
          type: PouchDB,
          value: new PouchDB('http://localhost:5984/personsdb'),
        },

        // Local DB, the synched version of `remoteDB`
        localDB: {
          type: PouchDB,
          value: new PouchDB('local_personsdb'),
        },

        allDocs: Array, // All docs in the grid.

        size: Number, // Size of total rows in the grid.

        searchResults: Array, // Filter grid based on those results.
      },

      _getSelectedItem() {
        return this.selectedItems[0];
      },

      _setSelectedItem(selectedItem) {
        if(selectedItem) {
          this.selectedItems = [selectedItem];
        }else {
          this.selectedItems = [];
        }
      },

      _activeItemChanged: function(activeItem) {
        this._setSelectedItem(activeItem);
      },

      _selectedItemsChanged: function() {
        // this._getSelectedItem() && alert("yo" + this._getSelectedItem().firstName)
        this.fire('on-select', {selected: this._getSelectedItem()});
      },

      _refreshGrid: function() {
        // TODO: Problem when clicking on update twice
        this.$.lazyGrid.clearCache();
        this.$.lazyGrid._scrollToIndex(this._getSelectedItem().idx);
      },

      _loadData: function() {
        PouchDB.sync(this.remoteDB, this.localDB, {
          live: true,
          retry: true,
        });

        // TODO: Sort items, but this is server-side issue
        this.localDB.allDocs({endkey: '_design'}).then(eResult => {
          this.localDB.allDocs({startkey: '_design\uffff'}).then(sResult => {
            this.allDocs = eResult.rows.concat(sResult.rows);
            this.size = this.allDocs.length;

            this.dataProvider = (params, callback) => {

              var currentIndex = params.page;
              var usedDocs = this.searchResults ? this.searchResults : this.allDocs;

              // Construct docs starting from current index,
              // and up to the requested length by Grid.
              var currentDocs = usedDocs.slice(currentIndex, currentIndex+params.pageSize);

              var data = [];
              if(currentDocs.length > 0) {
                this.localDB.bulkGet({
                    docs: currentDocs,
                }).then(json => {
                  for(var i=0; i<json.results.length; i++) {
                    data[i] = json.results[i].docs[0].ok;
                    data[i].idx = i + currentIndex;

                    // Hilight docs in search mode
                    if(this.searchResults && currentDocs[i].highlighting) {
                      for (prop in currentDocs[i].highlighting) {
                        var highlightKey = 'highlight_' + prop.replace('.', '_');
                        data[i][highlightKey] = currentDocs[i].highlighting[prop];
                      }
                    }else {
                      for(prop in data[i]) {
                        if(prop.startsWith('highlight_')) {
                          delete data[i][prop];
                        }
                      }
                    }
                  }
                  callback(data);
                });
              }else {
                callback(data);
              }
            }
          });
        });
      },

      ready: function() {
        // For first visit, we must replicate first
        this.localDB.info().then(localdbinfo => {
          if(localdbinfo.doc_count === 0) {
            // TODO: Handle error
            // TODO: Do this in the background and display already loaded data
            PouchDB.replicate(this.remoteDB, this.localDB).on('complete', info => {
              this._loadData();
            });
          }else {
            this._loadData();
          }
        });
      },

      update: function(newPerson) {
        this.localDB.put(newPerson).then(response => {
          this._refreshGrid();
        });
      },

      create: function(newPerson) {
        this.localDB.post(newPerson).then(response => {
          // Insert in the begining
          this.allDocs.unshift({
            id: response.id
          });
          this.size = this.allDocs.length;
          newPerson.idx = 0;
          newPerson._id = response.id;
          this._setSelectedItem(newPerson);
          this._refreshGrid();
        });
      },

      search: function(value) {
        // Make sure to unselect any selected item
        this._setSelectedItem(null);

        if(value) {
          // TODO: Fix custom search
          this.localDB.search({
            query: value,
            fields: ['firstName',
                    'lastName',
                    'address.street',
                    'address.city',
                    'address.state',
                    'address.zip',
                    'address.country',
                    'address.phone',
                    'address.email'
                    ],
            highlighting: true,
            highlighting_pre: '<span class="search-highlight">',
            highlighting_post: '</span>'
          }).then(response => {
            this.searchResults = response.rows;
            this.size = response.total_rows;
            this.$.lazyGrid.clearCache();
          }).catch(function (err) {
            // TODO: Handle error
          });
        }else {
          // Clear search
          this.searchResults = undefined;
          this.size = this.allDocs.length;
          this.$.lazyGrid.clearCache();
        }
      },

      add: function() {
        // Clear selection first
        this._setSelectedItem(null);

        this.fire('on-add');
      },

    });
  </script>
</dom-module>
